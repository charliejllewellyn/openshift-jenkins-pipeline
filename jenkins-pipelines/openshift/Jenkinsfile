node ('openshift-jenkins-pipeline') {

    stage('code-checkout') {
        git branch:"develop", url:"https://github.com/UKCloud/openshift-heat.git"
    }

    stage('setup OpenStack credentials') {
        sh "echo export OS_PASSWORD=`oc get secrets openstack --template='{{ .data.password }}' | base64 --decode` | tee -a openstack_rc.sh"
        sh "echo export OS_USERNAME=`oc get secrets openstack --template='{{ .data.username }}' | base64 --decode` | tee -a openstack_rc.sh"
        sh "echo -e \"parameter_defaults:\\n  rhn_orgid: `oc get secrets rhelsubscriptions --template='{{ .data.rhel_org }}' | base64 --decode`\" | tee rhel_reg_creds.yaml"
        sh "echo -e \"  rhn_activationkey: `oc get secrets rhelsubscriptions --template='{{ .data.rhel_activation_key }}' | base64 --decode`\" | tee -a rhel_reg_creds.yaml"
        sh "echo export OS_TENANT_ID=`oc get configmap openstack-config --template='{{ .data.openstack_project_id }}'` | tee -a openstack_rc.sh"
        sh "echo export OS_AUTH_URL=`oc get configmap openstack-config --template='{{ .data.openstack_url }}'` | tee -a openstack_rc.sh"
    }

//    stage('cleanup HEAT environment') {
//        sh 'source ./openstack_rc.sh ; openstack stack show openshift_customer2 && openstack stack delete openshift_customer2 || echo stack not found'
//    }
//
//    stage('setup host keys') {
//        sh 'source ./openstack_rc.sh ; openstack keypair delete jenkins ; openstack keypair create jenkins | tee -a id_rsa_jenkins'
//    }
//
//    stage('setup HEAT environment') {
//        sh("source ./openstack_rc.sh ; openstack stack create -f yaml -t openshift.yaml openshift_customer2 -e rhel_reg_creds.yaml --parameter key_name=jenkins --wait --parameter time=\"\$(date)\" --parameter domain_suffix=customer1.openshift.ukcloud.com --parameter os_auth_url=\$OS_AUTH_URL --parameter os_tenant_id=\$OS_TENANT_ID --parameter os_tenant_name=\$OS_TENANT_NAME --parameter os_region=\$OS_REGION_NAME --parameter openshift_openstack_username=\$OS_USERNAME --parameter openshift_openstack_password=\$OS_PASSWORD")
//    }

    stage('Test HEAT deployment') {
        sh('echo -e "-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA1LvmOAL05L0tF0nONYKgBO1Kq+GisOKI2XGdaVC9AlN5I7Fe\nfU8q4pXtkpUvO0LUyVgBdw2nzV0PRCRk8Pfo+woggQ84NrIxL4hs2DqDKMoWfQWQ\nOavwxXUK11RG6LdoSywqVy2jK5vxl+v01m+YGE8QnywUufLJ/M1nOr/0AkSg8msH\nE2EOUSlklkHrsUfZ3I4HY1lqHQPPPTJINrklqEubW088N5aY6a+w3Zaj+TRwdiev\nTSNoD5r6JD9fiYiP8XWlKmmTaPviAUC0EnB/NSAq6zdzcycfAybT/sjCxEvRucP6\ng7IJncHY8Rwhh/zS1NgZ/WDQvYBLnTmfSyVGRwIDAQABAoIBAC4TwMqzAT4mJ4Ua\nzFpUv7oxd3IBPk7X0lJexHySK048rElp2pCDvEM1vC56t687S4GM2UxjHcxicrMM\nuvxihgkR6XZqyH84W2TzRLgU/GGyW+qacOG89zqdnkqDi5ROXX2ixEz7qpMAhPSl\n+/MSWrwxK+V+E8Mu7kcealSUTRLMS2BuVk9d1cfLR1oMwDfOslhx+/x3IBU+FpCE\n2lt+55dheZX/2q4dh1FgPq0yy/zhKpIW7Xhas0NJrS2GAmlZIryzhODC8ahLHRV+\nLQNrD/zh8orTEDjUOxeLBJ3y/KN4WBWq/FXXdv4aipN5ngc5vx8ysCted5u9PIkd\nvDZszJECgYEA9fJv5XtTxqh5aRjnzP7Lace1+JWHhFL7QwxlUnJbrj361GO2bRvk\nVXODpJ5kX8vHzqMK3lK4WvLqYI1SGPzc2JMCPeFmG1wJZKZwjYtxWbUlK0bH7gld\nK++/Gzh8F8v6RPavBs3JP3xKqeH7AWd4hi7No3g6pM04TnSUodyzJCkCgYEA3W3s\nsLQFUvSKIBNlurQqMplkSVX/HkjilqPDXi49tMN6HOlAZDx2F7GMsaIpSCIBdoBK\nAC/+4xeD2RFFCGDIbPrAWKd2qniG+qXLwkx9xw3b9Bq2jutb1QjMg4mMX4qYy1LV\nbzIwVeNTtzgsJ06+SsrDOFFqJObDA/OQY3xi5O8CgYB+tpJp8/k8n641tIwwtJFO\nhYM+eKOiTDKB39AQAzUy92HUrS7e1gD0+Ze4Z5alOFNQJfZChvHOgdq5NfY3Q4fw\n2QTNpuQ5cliwj4PrmQ0kP8zPmB8Hh7GGInYeayKcDA58G3AfnER0PfAlyHTOy2Vw\nFIsEDryADe9VlIDDR/bPyQKBgQC+mwcpvGzw0ausnMXvB3NjhwL61dn72cWi4mkk\nQy2+0p3lESvqnNkS4DU6G1rpysvzk88fhjEkjnNigSkpYxZkKR01s0HE0GdwjxNs\nt6d1l4qFABGxyQuNwDs750U8YPPR4gXz6AIPjNXdW682TuQjQZL2ga6bAUFRv3HF\nEaeXZQKBgQC3tk+lPHVoVqYDQusSnItNwNYVyg5MkPE5RhMcijEo0YN1Wl53LwiO\n97RUo8QXnB6HqAeZIiGUfXZ8uR1cdQstnc3j0m/qWbNEHqiyVUQ+yAZaXlL3pj8s\nhF7SU0LmlInhZKq4tGTdPFIdDVDVGSnKJffC/KnxEVPwvE1brO6HSg==\n-----END RSA PRIVATE KEY-----" > id_rsa_jenkins')
        sh('source ./openstack_rc.sh ; openstack floating ip list')
    }
}
